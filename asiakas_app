import streamlit as st
import json
import requests

# Funktio asiakaslistan hakemiseen
def get_customer_list():
    try:
        with open("customers.json", "r", encoding="utf-8") as f:
            return json.load(f).get("data", [])
    except FileNotFoundError:
        st.error("Tiedostoa 'customers.json' ei l√∂ytynyt!")
        return []
    except Exception as e:
        return []

# Suodatetaan autot kirjautuneen asiakkaan ID:n perusteella
def get_filtered_car_list(customer_id):
    try:
        with open("vehicles.json", "r", encoding="utf-8") as f:
            all_cars = json.load(f).get("data", [])
            if customer_id != "unknown":
                return [c for c in all_cars if c.get('customer_id') == customer_id]
            return []
    except Exception as e:
        return []

st.set_page_config(page_title="MechServAI - Asiakas", page_icon="üöó")
st.title("üöó MechServAI - Asiakasportaali")

# --- KIRJAUTUMINEN SIVUPALKISSA  ---
st.sidebar.header("Kirjaudu sis√§√§n")
customers = get_customer_list()
current_user = {"customer_id": "unknown", "name": "Vieras"}

if customers:
    # Nimi kirjoitetaan tekstikentt√§√§n 
    input_name = st.sidebar.text_input("Koko nimi:")
    input_password = st.sidebar.text_input("Salasana:", type="password")
    
    if input_name and input_password:
        # Etsit√§√§n asiakas, jonka nimi (ei riippuvainen kirjainkoosta) ja salasana t√§sm√§√§v√§t
        user_match = next((c for c in customers if c["name"].strip().lower() == input_name.strip().lower() 
                          and c["password"] == input_password), None)
        
        if user_match:
            current_user = user_match
            st.sidebar.success(f"Tervetuloa, {current_user['name']}!")
        else:
            st.sidebar.error("Nimi tai salasana on v√§√§rin.")
else:
    st.sidebar.error("Asiakastietoja ei l√∂ytynyt.")

# --- P√Ñ√ÑN√ÑKYM√Ñ ---
tabs = st.tabs(["üìã Tee huoltovaraus", "üîç Diagnostiikka"])

with tabs[0]:
    st.header("Uusi huoltovaraus")
    
    if current_user["customer_id"] != "unknown":
        my_cars = get_filtered_car_list(current_user["customer_id"])
        
        if my_cars:
            car_display_list = [f"{c['make']} {c['model']} ({c['model_year']}) - {c['plate_number']}" for c in my_cars]
            selected_car_index = st.selectbox("Valitse autosi:", range(len(car_display_list)), format_func=lambda x: car_display_list[x])
            selected_car_data = my_cars[selected_car_index]
            
            desc = st.text_area("Kuvaile huoltotarve (esim. jakohihnan vaihto):")

            if st.button("L√§het√§ varaus analyysiin"):
                if desc.strip():
                    with st.spinner("MechServAI analysoi varaustasi..."):
                        payload = {
                            "mode": "booking",
                            "customer_id": current_user["customer_id"],
                            "customer_name": current_user["name"],
                            "vehicle_id": selected_car_data["vehicle_id"],
                            "car_info": car_display_list[selected_car_index],
                            "engine_code": selected_car_data["engine"]["engine_code"],
                            "customer_description": desc
                        }
                        
                        try:
                            # Huom: n8n webhook-test osoite
                            response = requests.post("http://localhost:5678/webhook-test/uusi-varaus", json=payload, timeout=None)
                            if response.status_code == 200:
                                st.success(f"Kiitos {current_user['name']}!")
                                st.info(f"**Varaussuositus:**\n\n{response.text}")
                            else:
                                st.error("Virhe n8n-yhteydess√§.")
                        except Exception as e:
                            st.error(f"Yhteysvirhe: {e}")
                else:
                    st.warning("Kirjoita kuvaus.")
        else:
            st.warning("Sinulle ei l√∂ytynyt rekister√∂ityj√§ autoja.")
    else:
        st.info("Kirjaudu sis√§√§n nimesi ja salasanasi avulla n√§hd√§ksesi autosi.")

with tabs[1]:
    st.header("MechServAI √Ñlyk√§s Diagnostiikka")
    symptom = st.text_input("Kuvaile oiretta:", key="diag_symptom")
    
    if symptom:
        if current_user["customer_id"] != "unknown":
            with st.spinner("Analysoidaan..."):
                payload = {
                    "mode": "diagnostics",
                    "customer_id": current_user["customer_id"],
                    "customer_description": symptom
                }
                try:
                    response = requests.post("http://localhost:5678/webhook-test/uusi-varaus", json=payload, timeout=None)
                    st.info(response.text)
                except Exception as e:
                    st.error(f"Virhe: {e}")
        else:
            st.warning("Kirjaudu sis√§√§n k√§ytt√§√§ksesi diagnostiikkaa.")
