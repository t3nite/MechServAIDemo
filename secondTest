import json
from langchain_ollama import OllamaLLM

llm = OllamaLLM(model="llama3.1", temperature=0)

# Ladataan feikkidata
with open("mock_data.json", "r", encoding="utf-8") as f:
    db = json.load(f)

def create_work_order(customer_input):
    """VAIHE 1 & 2: Työnjohdon varaus ja mekaanikon ohjeistus"""
    
    # Valitaan auto ja työ (tässä yksinkertaistettu haku)
    car = db["cars"][0]
    job = next(j for j in db["jobs"] if "jakohihna" in j["job"])
    mechanic = next(m for m in db["mechanics"] if m["available"])
    
    parts_total = sum(p["price"] for p in job["parts"])
    labor_total = job["hours"] * db["hourly_rate"]
    total = parts_total + labor_total

    # Englanninkielinen prompti takaa paremman logiikan
    prompt = f"""
    ROLE: Expert Automotive Service Advisor.
    TASK: Create a technical brief for the mechanic.
    
    DATA:
    - Car: {car['brand']} {car['model']} ({car['engine']})
    - Customer Symptom: {customer_input}
    - Job: {job['job']}
    - Parts: {job['parts']}
    - Labor: {job['hours']} hours
    
    INSTRUCTIONS (Answer in Finnish):
    1. Verify if the job matches the symptom.
    2. List 3 critical technical points for this specific belt change.
    3. Be professional and brief. Use technical terms like 'ajoitus', 'kiristin', 'vesipumppu'.
    """
    
    print("\n--- SERVAI: TYÖMÄÄRÄIN MEKAANIKOLLE ---")
    response = llm.invoke(prompt)
    print(response)
    return {"car": car, "job": job, "mechanic": mechanic, "total": total}

def finish_work(work_order, mechanic_notes):
    """VAIHE 3: Työn valmistuminen ja viesti asiakkaalle"""
    
    prompt = f"""
    ROLE: Customer Service Agent at a Car Repair Shop.
    CONTEXT: Job "{work_order['job']['job']}" for {work_order['car']['brand']} is finished.
    MECHANIC NOTES: "{mechanic_notes}"
    TOTAL PRICE: {work_order['total']} EUR
    
    TASK (Answer in Finnish):
    1. Write a polite text message to the customer.
    2. Summarize what was done.
    3. Mention if the mechanic found additional issues (lisätyöt).
    4. Keep it friendly but professional.
    """
    
    print("\n--- SERVAI: VIESTI ASIAKKAALLE ---")
    response = llm.invoke(prompt)
    print(response)

# --- DEMON AJAMINEN ---

# 1. Tiskillä/Kotona tapahtuva varaus
active_job = create_work_order("Jakohihnan vaihto ja tarkistus")

print("\n" + "="*30 + "\n")

# 2. Mekaanikko kuittaa työn tehdyksi ja lisää omat havaintonsa
# Tässä mekaanikko huomaa oikean vian, jonka AI poimii viestiin
mechanic_input = "Työ tehty. Huomattu, että apulaitehihna on halkeillut. Suositellaan vaihtoa 5000km sisällä."
finish_work(active_job, mechanic_input)
